import json
import boto3
import urllib3
from datetime import datetime

# Configuration
SECRET_ARN = "arn:aws:secretsmanager:us-east-1:629904435132:secret:dev/alpha_vantage-wbLVgz"
S3_BUCKET = "raw-us-east-1-jngai-dev"
BASE_URL = "https://www.alphavantage.co/query"

# Clients
http = urllib3.PoolManager()
s3 = boto3.client("s3")
secrets = boto3.client("secretsmanager")

def get_api_key():
    res = secrets.get_secret_value(SecretId=SECRET_ARN)
    return json.loads(res["SecretString"])["FreeApiKey"]

def get_date_params():
    now = datetime.utcnow()
    quarter_num = (now.month - 1) // 3 + 1
    return {
        "quarter": f"{now.year-1}Q{quarter_num}"
    }

def parse_tickers(tickers_input):
    if isinstance(tickers_input, str):
        tickers_input = tickers_input.replace(",", " ").split()
    return [t.strip().upper() for t in (tickers_input or []) if str(t).strip()]

def process_ticker(symbol, date_params, api_key):
    params = {
        "function": "EARNINGS_CALL_TRANSCRIPT",
        "symbol": symbol,
        "quarter": date_params["quarter"],
        "apikey": api_key
    }

    try:
        url = f"{BASE_URL}?" + "&".join(f"{k}={v}" for k, v in params.items())
        raw_res = http.request("GET", url)
        data = json.loads(raw_res.data.decode("utf-8"))

        print(url)

        # Check for API-side errors
        if any(k in data for k in ["Note", "Error Message", "Information"]):
            return {
                "symbol": symbol,
                "status": "error",
                "message": data.get("Note")
                or data.get("Error Message")
                or "Data not available"
            }

        key = f"earnings_calls/{symbol}/{date_params['quarter']}.json"
        s3.put_object(
            Bucket=S3_BUCKET,
            Key=key,
            Body=json.dumps(data),
            ContentType="application/json"
        )

        return {"symbol": symbol, "status": "success", "s3_key": key}

    except Exception as e:
        return {"symbol": symbol, "status": "error", "message": str(e)}

def lambda_handler(event, context):
    # Support both 'tickers' and 'symbol' keys
    raw_input = event.get("tickers") or event.get("symbol")
    tickers = parse_tickers(raw_input)

    if not tickers:
        return {
            "statusCode": 400,
            "body": json.dumps({
                "error": "No tickers provided in 'tickers' or 'symbol' field"
            })
        }

    api_key = get_api_key()
    date_params = get_date_params()

    results = [
        process_ticker(symbol, date_params, api_key)
        for symbol in tickers
    ]

    failed = [r for r in results if r["status"] == "error"]
    status_code = 200 if not failed else (207 if len(failed) < len(tickers) else 400)

    return {
        "statusCode": status_code,
        "body": json.dumps({
            "quarter": date_params["quarter"],
            "summary": {
                "total": len(tickers),
                "failed": len(failed)
            },
            "results": results
        })
    }
